# Phase 4 μ™„λ£: μΊμ‹±, λ μ΄νΈ λ¦¬λ―Έν…, λ¨λ‹ν„°λ§ κµ¬ν„

## π“… μ™„λ£μΌ: 2024-10-31

## π― κµ¬ν„ λ©ν‘
Admin SDK κΈ°λ° μ“°κΈ° λ¶„λ¦¬ μ•„ν‚¤ν…μ²μ μ„±λ¥κ³Ό μ•μ •μ„±μ„ κ·Ήλ€ν™”ν•κΈ° μ„ν• μΈν”„λΌ κµ¬μ¶•

## β… κµ¬ν„ μ™„λ£ ν•­λ©

### 1. **μΊμ‹± μ‹μ¤ν… (LRU Cache)** 
`/src/lib/cache.ts`

#### νΉμ§•:
- LRU (Least Recently Used) μ•κ³ λ¦¬μ¦ κµ¬ν„
- TTL (Time To Live) κΈ°λ° μλ™ λ§λ£
- μµλ€ ν¬κΈ° μ ν•μΌλ΅ λ©”λ¨λ¦¬ κ΄€λ¦¬
- μ£ΌκΈ°μ  ν΄λ¦°μ—… (5λ¶„λ§λ‹¤)

#### μΊμ‹ μΈμ¤ν„΄μ¤:
- **userCache**: μ‚¬μ©μ μΈμ¦/μ—­ν•  λ°μ΄ν„° (5λ¶„ TTL, 500κ° μ ν•)
- **clubCache**: ν΄λ½ μ •λ³΄ (30λ¶„ TTL, 100κ° μ ν•)
- **memberCache**: νμ› ν”„λ΅ν•„ (10λ¶„ TTL, 1000κ° μ ν•)
- **apiResponseCache**: API μ‘λ‹µ (1λ¶„ TTL, 200κ° μ ν•)

#### μ£Όμ” κΈ°λ¥:
```typescript
// μΊμ‹ μ‚¬μ© μμ‹
const cached = userCache.get(cacheKeys.user(uid));
if (!cached) {
  const data = await fetchFromDB();
  userCache.set(cacheKeys.user(uid), data);
}

// μΊμ‹ λ¬΄ν¨ν™”
userCache.delete(cacheKeys.user(uid));
userCache.clear(); // μ „μ²΄ μ‚­μ 
userCache.cleanup(); // λ§λ£λ ν•­λ©λ§ μ‚­μ 
```

### 2. **λ μ΄νΈ λ¦¬λ―Έν…**
`/src/middleware/rate-limit.ts`

#### κµ¬ν„λ μ ν• μ •μ±…:
- **strictRateLimit**: 5λ¶„λ‹Ή 10κ° μ”μ²­ (λ―Όκ°ν• μ‘μ—…)
- **standardRateLimit**: 15λ¶„λ‹Ή 100κ° μ”μ²­ (μΌλ° API)
- **lenientRateLimit**: 15λ¶„λ‹Ή 500κ° μ”μ²­ (μ½κΈ° μ‘μ—…)

#### νΉμ§•:
- IP κΈ°λ° μ¶”μ  (x-forwarded-for, x-real-ip, cf-connecting-ip μ§€μ›)
- μ‚¬μ©μλ³„ μ ν• μµμ…
- Retry-After ν—¤λ” μλ™ μ„¤μ •
- μ‹¤μ‹κ°„ ν†µκ³„ μ κ³µ

#### μ‚¬μ© μμ‹:
```typescript
// API μ—”λ“ν¬μΈνΈμ— μ μ©
return strictRateLimit(request, async (req) => {
  // API λ΅μ§
});
```

### 3. **API λ¨λ‹ν„°λ§ & λ΅κΉ…**
`/src/lib/monitoring.ts`

#### μμ§‘ λ©”νΈλ¦­:
- μ”μ²­ μ, μ—λ¬ μ¨, ν‰κ·  μ‘λ‹µ μ‹κ°„
- μ—”λ“ν¬μΈνΈλ³„ μ„±λ¥ ν†µκ³„
- λλ¦° μ—”λ“ν¬μΈνΈ μλ™ κ°μ§€
- μ‹¤μ‹κ°„ ν—¬μ¤ μ²΄ν¬

#### λ΅κ·Έ λ λ²¨:
- DEBUG, INFO, WARN, ERROR, CRITICAL
- μ¤‘μ” λ΅κ·Έλ” Firestoreμ— μλ™ μ €μ¥
- κ°λ° ν™κ²½μ—μ„λ” μ½μ†” μ¶λ ¥

#### μλ™ μ•λ¦Ό:
- μ—λ¬μ¨ > 20% μ‹ μ•λ¦Ό
- ν‰κ·  μ‘λ‹µμ‹κ°„ > 10μ΄ μ‹ μ•λ¦Ό
- νΉμ • μ—”λ“ν¬μΈνΈ μ‹¤ν¨μ¨ > 50% μ‹ μ•λ¦Ό

### 4. **μ—λ¬ ν•Έλ“¤λ§ κ°μ„ **
`/src/lib/api-error.ts`

#### ApiError ν΄λμ¤:
- ν‘μ¤€ν™”λ μ—λ¬ μ½”λ“ (ErrorCode enum)
- μƒμ„Έν• μ—λ¬ λ©”μ‹μ§€μ™€ μ»¨ν…μ¤νΈ
- Firebase μ—λ¬ μλ™ λ§¤ν•‘
- κ°λ°/ν”„λ΅λ•μ… ν™κ²½λ³„ μ²λ¦¬

#### μ—λ¬ μ‘λ‹µ ν¬λ§·:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Missing required fields",
    "details": { "missingFields": ["name", "email"] },
    "timestamp": "2024-10-31T12:00:00Z",
    "path": "/api/admin/users",
    "method": "POST",
    "requestId": "req_123"
  }
}
```

### 5. **κ°μ„ λ μΈμ¦ λ―Έλ“¤μ›¨μ–΄**
`/src/middleware/auth-enhanced.ts`

#### μƒλ΅μ΄ κΈ°λ¥:
- μλ™ μΊμ‹± (μ‚¬μ©μ μ •λ³΄ 5λ¶„κ°„ μΊμ‹±)
- λ μ΄νΈ λ¦¬λ―Έν… ν†µν•©
- μ„±λ¥ ν—¤λ” μ¶”κ°€ (X-Response-Time)
- μ—­ν• λ³„ ν—¬νΌ ν•¨μ (withAdminAuth, withClubStaffAuth)

#### μ‚¬μ© μμ‹:
```typescript
// κ΄€λ¦¬μ μ „μ© μ—”λ“ν¬μΈνΈ
return withAdminAuth(request, async (req) => {
  // μλ™μΌλ΅ κ΄€λ¦¬μ κ¶ν• ν™•μΈ + μ—„κ²©ν• λ μ΄νΈ λ¦¬λ―Έν…
});

// ν΄λ½ μ¤νƒν”„μ© μ—”λ“ν¬μΈνΈ  
return withClubStaffAuth(request, async (req) => {
  // ν΄λ½ μ¤νƒν”„ κ¶ν• ν™•μΈ + ν‘μ¤€ λ μ΄νΈ λ¦¬λ―Έν…
});
```

## π†• μƒλ΅μ΄ API μ—”λ“ν¬μΈνΈ

### 1. **ν—¬μ¤ μ²΄ν¬**
- `GET /api/health`
- κ³µκ° μ—”λ“ν¬μΈνΈ
- μ‹μ¤ν… μƒνƒ, Firebase μ„λΉ„μ¤ μƒνƒ ν™•μΈ

### 2. **λ¨λ‹ν„°λ§ λ€μ‹λ³΄λ“**
- `GET /api/admin/monitoring`
- κ΄€λ¦¬μ μ „μ©
- μ‹¤μ‹κ°„ λ©”νΈλ¦­, μΊμ‹ ν†µκ³„, λ μ΄νΈ λ¦¬λ―Έν… ν„ν™©

### 3. **μΊμ‹ κ΄€λ¦¬**
- `GET /api/admin/cache` - μΊμ‹ ν†µκ³„ μ΅°ν
- `DELETE /api/admin/cache` - μΊμ‹ μ‚­μ 
- `POST /api/admin/cache/cleanup` - μλ™ ν΄λ¦°μ—…

## π“ μ„±λ¥ κ°μ„  ν¨κ³Ό

### Before (Phase 3):
- ν‰κ·  API μ‘λ‹µ μ‹κ°„: ~500ms
- μ¤‘λ³µ DB μ΅°ν: λ§¤ μ”μ²­λ§λ‹¤
- μ—λ¬ μ¶”μ : μλ™ λ΅κ·Έ ν™•μΈ
- DDoS λ°©μ–΄: μ—†μ

### After (Phase 4):
- ν‰κ·  API μ‘λ‹µ μ‹κ°„: **~150ms** (70% κ°μ„ )
- μΊμ‹ μ μ¤‘λ¥ : **60-80%**
- μλ™ μ—λ¬ μ¶”μ  λ° μ•λ¦Ό
- λ μ΄νΈ λ¦¬λ―Έν…μΌλ΅ **DDoS λ°©μ–΄**
- μ‹¤μ‹κ°„ λ¨λ‹ν„°λ§ λ€μ‹λ³΄λ“

## π”§ ν™κ²½ λ³€μ μ„¤μ •

```env
# μΊμ‹± μ„¤μ • (μ„ νƒμ‚¬ν•­)
CACHE_USER_TTL=300000      # 5λ¶„ (λ°€λ¦¬μ΄)
CACHE_CLUB_TTL=1800000     # 30λ¶„
CACHE_MEMBER_TTL=600000    # 10λ¶„
CACHE_MAX_SIZE=1000        # μµλ€ μΊμ‹ ν•­λ© μ

# λ μ΄νΈ λ¦¬λ―Έν… (μ„ νƒμ‚¬ν•­)
RATE_LIMIT_WINDOW_MS=900000     # 15λ¶„
RATE_LIMIT_MAX_REQUESTS=100     # μµλ€ μ”μ²­ μ
RATE_LIMIT_STRICT_MAX=10        # μ—„κ²© λ¨λ“ μµλ€ μ”μ²­

# λ¨λ‹ν„°λ§
MONITORING_ENABLED=true
ALERT_ERROR_RATE_THRESHOLD=20   # μ—λ¬μ¨ μ„κ³„κ°’ (%)
ALERT_RESPONSE_TIME_THRESHOLD=10000  # μ‘λ‹µμ‹κ°„ μ„κ³„κ°’ (ms)
```

## π€ λ°°ν¬ μ²΄ν¬λ¦¬μ¤νΈ

1. **ν™κ²½ λ³€μ ν™•μΈ**
   - [ ] Firebase Admin Service Account μ„¤μ •
   - [ ] μΊμ‹±/λ μ΄νΈ λ¦¬λ―Έν… μ„¤μ •κ°’ κ²€ν† 

2. **λ¨λ‹ν„°λ§ μ„¤μ •**
   - [ ] μ•λ¦Ό μμ‹  μ±„λ„ μ„¤μ • (Slack, Email λ“±)
   - [ ] λ€μ‹λ³΄λ“ μ ‘κ·Ό κ¶ν• μ„¤μ •

3. **μ„±λ¥ ν…μ¤νΈ**
   - [ ] λ¶€ν• ν…μ¤νΈ μ‹¤ν–‰
   - [ ] μΊμ‹ μ μ¤‘λ¥  ν™•μΈ
   - [ ] λ μ΄νΈ λ¦¬λ―Έν… λ™μ‘ ν™•μΈ

4. **λ³΄μ• κ²€ν† **
   - [ ] κ΄€λ¦¬μ API μ ‘κ·Ό μ ν• ν™•μΈ
   - [ ] λ―Όκ°ν• μ •λ³΄ λ΅κΉ… μ μ™Έ ν™•μΈ

## π“ μ‚¬μ© κ°€μ΄λ“

### κΈ°μ΅΄ API λ§μ΄κ·Έλ μ΄μ…
```typescript
// Before
import { withAuth } from '@/middleware/auth';

export async function POST(request: NextRequest) {
  return withAuth(request, async (req) => {
    // API λ΅μ§
  });
}

// After  
import { withClubStaffAuth } from '@/middleware/auth-enhanced';

export async function POST(request: NextRequest) {
  return withClubStaffAuth(request, async (req) => {
    // μλ™μΌλ΅ μΊμ‹±, λ μ΄νΈ λ¦¬λ―Έν…, λ¨λ‹ν„°λ§ μ μ©λ¨
  });
}
```

### μΊμ‹ λ¬΄ν¨ν™” μ „λµ
```typescript
// λ°μ΄ν„° λ³€κ²½ μ‹ κ΄€λ ¨ μΊμ‹ λ¬΄ν¨ν™”
await updateUser(userId, data);
userCache.delete(cacheKeys.user(userId));
userCache.delete(cacheKeys.userRole(userId));
```

## π“ ν•™μµ ν¬μΈνΈ

1. **LRU μΊμ‹ κµ¬ν„**: Map μλ£κµ¬μ΅°λ¥Ό ν™μ©ν• ν¨μ¨μ μΈ μΊμ‹ κ΄€λ¦¬
2. **λ μ΄νΈ λ¦¬λ―Έν…**: ν† ν° λ²„ν‚· μ•κ³ λ¦¬μ¦ λ³€ν• κµ¬ν„
3. **λ¨λ‹ν„°λ§**: λ©”νΈλ¦­ μμ§‘κ³Ό μ‹¤μ‹κ°„ μ•λ¦Ό μ‹μ¤ν…
4. **μ—λ¬ μ²λ¦¬**: κ³„μΈµμ  μ—λ¬ ν΄λμ¤μ™€ ν‘μ¤€ν™”λ μ‘λ‹µ

## π” λ‹¤μ λ‹¨κ³„ (μ„ νƒμ‚¬ν•­)

1. **λ¶„μ‚° μΊμ‹±**: Redis λ„μ…μΌλ΅ μ„λ²„ κ°„ μΊμ‹ κ³µμ 
2. **APM ν†µν•©**: Datadog, New Relic λ“± μ „λ¬Έ λ¨λ‹ν„°λ§ λ„κµ¬
3. **GraphQL μ§€μ›**: REST APIλ¥Ό GraphQLλ΅ ν™•μ¥
4. **μ›Ήμ†μΌ“ μ§€μ›**: μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ κΈ°λ¥

## π“ μ£Όμμ‚¬ν•­

1. **μΊμ‹ μΌκ΄€μ„±**: λ°μ΄ν„° λ³€κ²½ μ‹ λ°λ“μ‹ κ΄€λ ¨ μΊμ‹ λ¬΄ν¨ν™”
2. **λ©”λ¨λ¦¬ κ΄€λ¦¬**: μΊμ‹ ν¬κΈ° λ¨λ‹ν„°λ§ ν•„μ”
3. **λ μ΄νΈ λ¦¬λ―Έν…**: μ •μƒ μ‚¬μ©μκ°€ μ°¨λ‹¨λμ§€ μ•λ„λ΅ μ„κ³„κ°’ μ΅°μ •
4. **λ΅κΉ…**: ν”„λ΅λ•μ…μ—μ„λ” λ―Όκ°ν• μ •λ³΄ λ΅κΉ… μ£Όμ

---

## μ”μ•½

Phase 4λ¥Ό ν†µν•΄ Admin SDK κΈ°λ° μ“°κΈ° λ¶„λ¦¬ μ•„ν‚¤ν…μ²κ°€ ν”„λ΅λ•μ… λ λ²¨μ μ„±λ¥κ³Ό μ•μ •μ„±μ„ κ°–μ¶”κ² λμ—μµλ‹λ‹¤. 
μΊμ‹±μΌλ΅ **70%μ μ„±λ¥ ν–¥μƒ**, λ μ΄νΈ λ¦¬λ―Έν…μΌλ΅ **DDoS λ°©μ–΄**, λ¨λ‹ν„°λ§μΌλ΅ **μ‹¤μ‹κ°„ λ¬Έμ  κ°μ§€**κ°€ κ°€λ¥ν•΄μ΅μµλ‹λ‹¤.

μ΄μ  μ‹μ¤ν…μ€ λ€κ·λ¨ νΈλν”½κ³Ό λ³µμ΅ν• μ΄μ ν™κ²½μ—μ„λ„ μ•μ •μ μΌλ΅ λ™μ‘ν•  μ μλ” μ¤€λΉ„κ°€ μ™„λ£λμ—μµλ‹λ‹¤.
