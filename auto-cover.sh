#!/usr/bin/env bash
set -e
TARGET=${1:-40}        # ëª©í‘œ ì»¤ë²„ë¦¬ì§€ (ê¸°ë³¸ 40%)
SLEEP=${2:-3}          # ê° ì‚¬ì´í´ ê°„ ëŒ€ê¸° ì‹œê°„(ì´ˆ)

read_rate() {
  # 1) Istanbul summary (generated by coverage-v8)
  if [ -f coverage/coverage-summary.json ]; then
    node -e "try{let s=require('./coverage/coverage-summary.json');console.log(s.total?.lines?.pct ?? 0)}catch(e){console.log(0)}"
    return
  fi
  # 2) Vitest JSON reporter (fallback)
  if [ -f .coverage-last.json ]; then
    node -e "try{let r=require('./.coverage-last.json');console.log(r.total?.lines?.pct ?? 0)}catch(e){console.log(0)}"
    return
  fi
  echo 0
}

while true; do
  npm run test:coverage -s >/dev/null 2>&1 || true

  RATE=$(read_rate)
  printf 'ðŸ“Š í˜„ìž¬ ì»¤ë²„ë¦¬ì§€: %.2f%%\n' "$RATE"

  # ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ ì²´í¬
  if awk -v r="$RATE" -v t="$TARGET" 'BEGIN{exit (r>=t)?0:1}'; then
    echo "âœ… ëª©í‘œ ${TARGET}% ë‹¬ì„± ì™„ë£Œ. ìžë™ ì¢…ë£Œ."
    break
  fi

  # ìžë™ ì»¤ë°‹ (ì„ íƒ)
  git add -A && git commit -m "test(auto): coverage ${RATE}%" >/dev/null 2>&1 || true

  sleep "$SLEEP"
done
