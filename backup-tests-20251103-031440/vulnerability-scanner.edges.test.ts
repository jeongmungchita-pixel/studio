import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { VulnerabilityScanner } from '../vulnerability-scanner';

describe('VulnerabilityScanner edges', () => {
  beforeEach(() => {
    vi.resetModules();
    vi.stubEnv('NODE_ENV', 'development');
  });
  afterEach(() => {
    vi.unstubAllEnvs();
  });

  it('runFullScan returns structured result and handles settled results', async () => {
    const result = await VulnerabilityScanner.runFullScan();
    expect(result).toHaveProperty('id');
    expect(result).toHaveProperty('summary');
    expect(result).toHaveProperty('riskScore');
    expect(result.summary.total).toBe(result.vulnerabilities.length);
  });

  it('generateReport returns json/html/csv strings', async () => {
    const result = await VulnerabilityScanner.runFullScan();
    const json = VulnerabilityScanner.generateReport(result, 'json');
    const html = VulnerabilityScanner.generateReport(result, 'html');
    const csv = VulnerabilityScanner.generateReport(result, 'csv');
    expect(typeof json).toBe('string');
    expect(html).toContain('<html>');
    expect(csv.split('\n')[0]).toContain('ID,Type,Severity');
  });
});
