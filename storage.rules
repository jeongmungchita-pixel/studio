/**
 * @file Firebase Storage Security Rules for KGF Nexus
 * @description Domain-based file access control
 * 
 * Storage Structure (aligned with domain architecture):
 * - /users/{userId}/profile/* - User profile images (Auth domain)
 * - /members/{memberId}/* - Member documents and media (Member domain)
 * - /clubs/{clubId}/* - Club logos and documents (Club domain)
 * - /events/{eventId}/* - Event photos and documents (Club domain)
 * - /classes/{classId}/* - Class materials (Club domain)
 * - /financial/{clubId}/* - Financial documents (Business domain)
 * - /public/* - Public assets accessible to all
 */
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // ğŸ”§ Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             getUserData().role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
    }
    
    function isClubStaff() {
      return isAuthenticated() && 
             getUserData().role in ['CLUB_OWNER', 'CLUB_MANAGER', 'COACH'];
    }
    
    function belongsToClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }
    
    function isOwnerOrAdmin(userId) {
      return isAuthenticated() && 
             (request.auth.uid == userId || isAdmin());
    }

    // ============================================
    // ğŸ‘¤ User Profile Images (Auth Domain)
    // ============================================
    
    match /users/{userId}/profile/{fileName} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì ëˆ„êµ¬ë‚˜ (í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” ê³µê°œ)
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow write: if isOwnerOrAdmin(userId);
      
      // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isOwnerOrAdmin(userId);
    }

    // ============================================
    // ğŸ‘¥ Member Files (Member Domain)
    // ============================================
    
    match /members/{memberId}/{allPaths=**} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || 
                     isClubStaff() || 
                     (isAuthenticated() && 
                      firestore.get(/databases/(default)/documents/members/$(memberId)).data.userId == request.auth.uid);
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || isClubStaff();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ¢ Club Files (Club Domain)
    // ============================================
    
    match /clubs/{clubId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì (í´ëŸ½ ì •ë³´ëŠ” ê³µê°œ)
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || 
                      (isClubStaff() && belongsToClub(clubId));
      
      // ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ì˜¤ë„ˆ
      allow delete: if isAdmin() || 
                       (isAuthenticated() && 
                        getUserData().role == 'CLUB_OWNER' && 
                        belongsToClub(clubId));
    }

    // ============================================
    // ğŸ‰ Event Files (Club Domain)
    // ============================================
    
    match /events/{eventId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || isClubStaff();
      
      // ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“š Class Files (Club Domain)
    // ============================================
    
    match /classes/{classId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || isClubStaff();
      
      // ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ’° Financial Documents (Business Domain)
    // ============================================
    
    match /financial/{clubId}/{allPaths=**} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || 
                     (isClubStaff() && belongsToClub(clubId));
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || 
                      (isClubStaff() && belongsToClub(clubId));
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ“‹ Registration Documents
    // ============================================
    
    match /registrations/{requestId}/{allPaths=**} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || isClubStaff();
      
      // ì“°ê¸°: ëˆ„êµ¬ë‚˜ (ê°€ì… ì‹ ì²­ ì‹œ ì„œë¥˜ ì—…ë¡œë“œ)
      allow write: if true;
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ† Competition Files
    // ============================================
    
    match /competitions/{competitionId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ“ Level Test Files
    // ============================================
    
    match /level_tests/{testId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow write: if isAdmin() || isClubStaff();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸŒ Public Assets
    // ============================================
    
    match /public/{allPaths=**} {
      // ì½ê¸°: ëˆ„êµ¬ë‚˜ (ê³µê°œ ìì‚°)
      allow read: if true;
      
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ“± App Assets (ë¡œê³ , ì•„ì´ì½˜ ë“±)
    // ============================================
    
    match /app/{allPaths=**} {
      // ì½ê¸°: ëˆ„êµ¬ë‚˜
      allow read: if true;
      
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸš« Deny all other access
    // ============================================
    
    // ëª…ì‹œë˜ì§€ ì•Šì€ ëª¨ë“  ì ‘ê·¼ ì°¨ë‹¨
  }
}
