/**
 * @file Firebase Security Rules for KGF Nexus (Production)
 * @description Role-based access control with domain-based architecture
 * 
 * Roles (defined in /src/constants/roles.ts):
 * - SUPER_ADMIN: Full system access
 * - FEDERATION_ADMIN: Federation-wide access
 * - CLUB_OWNER: Own club management access
 * - CLUB_MANAGER: Own club operational access
 * - COACH: Class and member management
 * - MEMBER: Own data access only
 * 
 * Domain Structure:
 * - Auth: Authentication and user management
 * - Member: Member data and operations
 * - Club: Club data and operations
 * - Business: Financial and administrative data
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // 🔧 Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'SUPER_ADMIN';
    }
    
    function isFederationAdmin() {
      return isAuthenticated() && getUserData().role == 'FEDERATION_ADMIN';
    }
    
    function isClubOwner() {
      return isAuthenticated() && getUserData().role == 'CLUB_OWNER';
    }
    
    function isClubManager() {
      return isAuthenticated() && getUserData().role == 'CLUB_MANAGER';
    }
    
    function isCoach() {
      return isAuthenticated() && getUserData().role == 'COACH';
    }
    
    function isClubStaff() {
      return isClubOwner() || isClubManager() || isCoach();
    }
    
    function isMember() {
      return isAuthenticated() && getUserData().role == 'MEMBER';
    }
    
    function isAdmin() {
      return isSuperAdmin() || isFederationAdmin();
    }
    
    function belongsToClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }

    // ============================================
    // 👤 Users Collection
    // ============================================
    
    match /users/{userId} {
      // 자기 프로필 읽기: 본인은 항상 가능 (순환 참조 방지)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // 다른 사용자 프로필 읽기: 관리자만 (최적화: 한 번만 체크)
      allow read: if isAuthenticated() && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
      
      // 프로필 생성: 본인만
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // 프로필 수정: 본인 또는 관리자 (최적화)
      allow update: if isAuthenticated() && 
                       (request.auth.uid == userId || 
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN']);
      
      // 프로필 삭제: 관리자만 (최적화)
      allow delete: if isAuthenticated() && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
      
      // 전체 목록: 관리자만 (최적화)
      allow list: if isAuthenticated() && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
    }

    // ============================================
    // 🏢 Clubs Collection
    // ============================================
    
    match /clubs/{clubId} {
      // 읽기: 인증된 사용자 누구나 (모든 클럽 정보는 공개)
      allow read: if isAuthenticated();
      
      // 생성: 관리자만 (클럽 등록 승인 후 생성)
      allow create: if isAdmin();
      
      // 수정: 관리자 또는 해당 클럽 오너
      allow update: if isAdmin() || 
                       (isAuthenticated() && 
                        resource.data.ownerId == request.auth.uid);
      
      // 삭제: 관리자만
      allow delete: if isAdmin();
      
      // 전체 목록 조회: 인증된 사용자 누구나
      allow list: if isAuthenticated();
    }

    // ============================================
    // 👥 Members Collection (Domain: Member)
    // ============================================
    
    match /members/{memberId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || 
                     isClubStaff() || 
                     (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // 생성: 관리자 또는 클럽 스태프 (회원 등록 승인 후)
      allow create: if isAdmin() || isClubStaff();
      
      // 수정: 관리자, 클럽 스태프, 본인 (제한적)
      allow update: if isAdmin() || 
                       isClubStaff() || 
                       (isAuthenticated() && 
                        resource.data.userId == request.auth.uid && 
                        // 본인은 개인정보만 수정 가능
                        !('status' in request.resource.data.diff(resource.data).affectedKeys()) &&
                        !('level' in request.resource.data.diff(resource.data).affectedKeys()) &&
                        !('clubId' in request.resource.data.diff(resource.data).affectedKeys()));
      
      // 삭제: 관리자만
      allow delete: if isAdmin();
      
      // 목록 조회: 관리자 또는 클럽 스태프
      allow list: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 🏆 Competitions Collection
    // ============================================
    
    match /competitions/{competitionId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성/수정/삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // 📝 Level Tests Collection
    // ============================================
    
    match /level_tests/{levelTestId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성/수정/삭제: 관리자 또는 클럽 스태프
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 📋 Requests Collections
    // ============================================
    
    match /clubOwnerRequests/{requestId} {
      // 읽기: 관리자 또는 본인
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // 생성: 누구나 가능 (가입 신청은 비회원도 가능)
      allow create: if true;
      
      // 수정/삭제: 관리자만
      allow update, delete: if isAdmin();
    }
    
    match /superAdminRequests/{requestId} {
      // 읽기/수정/삭제: SUPER_ADMIN만
      allow read, update, delete: if isSuperAdmin();
      
      // 생성: 누구나 가능 (최고 관리자 신청)
      allow create: if true;
    }
    
    match /federationAdminInvites/{inviteId} {
      // 읽기: 누구나 (초대 링크를 통한 접근 허용)
      allow read: if true;
      
      // 생성: 관리자만
      allow create: if isSuperAdmin();
      
      // 수정: 관리자 또는 초대받은 사람 (가입 시 상태 업데이트)
      allow update: if isSuperAdmin() || (isAuthenticated() && resource.data.email == request.auth.token.email);
      
      // 삭제: 관리자만
      allow delete: if isSuperAdmin();
    }
    
    match /coachRequests/{requestId} {
      // 읽기: 관리자 또는 요청한 클럽 스태프
      allow read: if isAdmin() || (isClubStaff() && resource.data.requestedBy == request.auth.uid);
      
      // 생성: 클럽 스태프
      allow create: if isClubStaff();
      
      // 수정/삭제: 관리자만
      allow update, delete: if isAdmin();
    }
    
    match /memberRegistrationRequests/{requestId} {
      // 읽기: 관리자 또는 해당 클럽 스태프
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // 생성: 누구나 (회원 가입 신청)
      allow create: if true;
      
      // 수정/삭제: 관리자 또는 해당 클럽 스태프
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // 성인 회원 가입 신청
    match /adultRegistrationRequests/{requestId} {
      // 읽기: 관리자 또는 해당 클럽 스태프
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // 생성: 누구나
      allow create: if true;
      
      // 수정/삭제: 관리자 또는 해당 클럽 스태프
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // 가족 회원 가입 신청
    match /familyRegistrationRequests/{requestId} {
      // 읽기: 관리자 또는 해당 클럽 스태프
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // 생성: 누구나
      allow create: if true;
      
      // 수정/삭제: 관리자 또는 해당 클럽 스태프
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // Deprecated: memberRequests는 memberRegistrationRequests로 통합됨
    match /memberRequests/{requestId} {
      allow read, write: if false; // 더 이상 사용하지 않음
    }

    // ============================================
    // 🎫 Passes & Attendance (Domain: Member)
    // ============================================
    
    match /member_passes/{passId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // 생성/수정/삭제: 관리자 또는 클럽 스태프
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /attendance/{attendanceId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // 생성/수정/삭제: 관리자 또는 클럽 스태프
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 📚 Classes & Templates (Domain: Club)
    // ============================================
    
    match /gym_classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /pass_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 📸 Media Collection
    // ============================================
    
    match /media/{mediaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 💰 Financial Collections (Domain: Business)
    // ============================================
    
    match /payments/{paymentId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update: if isAdmin() || isClubStaff();
      allow delete: if isAdmin();
    }
    
    match /financial_transactions/{transactionId} {
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      allow create: if isAdmin() || isClubStaff();
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    match /incomes/{incomeId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /expenses/{expenseId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /budgets/{budgetId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 📢 Announcements & Messages (Domain: Business)
    // ============================================
    
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /messageHistory/{messageId} {
      allow read: if isAdmin() || isClubStaff();
      allow create: if isAdmin() || isClubStaff();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // ⚙️ Settings Collections
    // ============================================
    
    match /club_bank_accounts/{accountId} {
      allow read: if isAdmin() || belongsToClub(accountId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(accountId));
    }
    
    match /naverCloudConfigs/{configId} {
      allow read: if isAdmin() || belongsToClub(configId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(configId));
    }

    // ============================================
    // 🏛️ Committees (위원회)
    // ============================================
    
    match /committees/{committeeId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성/수정/삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // 🎉 Events & Registrations (클럽 이벤트)
    // ============================================
    
    match /events/{eventId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성/수정/삭제: 관리자 또는 클럽 스태프
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /event_registrations/{registrationId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // 생성: 인증된 사용자
      allow create: if isAuthenticated();
      
      // 수정/삭제: 관리자 또는 클럽 스태프
      allow update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 📝 Level Test Registrations (승급심사 참가)
    // ============================================
    
    match /level_test_registrations/{registrationId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // 생성: 인증된 사용자
      allow create: if isAuthenticated();
      
      // 수정/삭제: 관리자 또는 클럽 스태프
      allow update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // 🏆 Competition Registrations (대회 참가)
    // ============================================
    
    match /competition_registrations/{registrationId} {
      // 읽기: 관리자, 클럽 스태프, 본인
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // 생성: 인증된 사용자
      allow create: if isAuthenticated();
      
      // 수정/삭제: 관리자만
      allow update, delete: if isAdmin();
    }

    // ============================================
    // ⚖️ Judges (심판)
    // ============================================
    
    match /judges/{judgeId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성/수정/삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // 🚫 Deny all other access
    // ============================================
    
    // 명시되지 않은 모든 접근 차단
  }
}