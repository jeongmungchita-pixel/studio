/**
 * @file Firebase Security Rules for KGF Nexus (Production)
 * @description Role-based access control
 * 
 * Roles:
 * - SUPER_ADMIN: Full access
 * - FEDERATION_ADMIN: Federation-wide access
 * - CLUB_OWNER: Own club access
 * - CLUB_MANAGER: Own club access
 * - MEMBER: Own data access
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ğŸ”§ Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'SUPER_ADMIN';
    }
    
    function isFederationAdmin() {
      return isAuthenticated() && getUserData().role == 'FEDERATION_ADMIN';
    }
    
    function isClubOwner() {
      return isAuthenticated() && getUserData().role == 'CLUB_OWNER';
    }
    
    function isClubManager() {
      return isAuthenticated() && getUserData().role == 'CLUB_MANAGER';
    }
    
    function isClubStaff() {
      return isClubOwner() || isClubManager();
    }
    
    function isMember() {
      return isAuthenticated() && getUserData().role == 'MEMBER';
    }
    
    function isAdmin() {
      return isSuperAdmin() || isFederationAdmin();
    }
    
    function belongsToClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }

    // ============================================
    // ğŸ‘¤ Users Collection
    // ============================================
    
    match /users/{userId} {
      // ìê¸° í”„ë¡œí•„ ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // í”„ë¡œí•„ ìƒì„±: ë³¸ì¸ë§Œ
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // í”„ë¡œí•„ ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // í”„ë¡œí•„ ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
      
      // ì „ì²´ ëª©ë¡: ê´€ë¦¬ìë§Œ
      allow list: if isAdmin();
    }

    // ============================================
    // ğŸ¢ Clubs Collection
    // ============================================
    
    match /clubs/{clubId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isAdmin();
      
      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow update: if isAdmin() || belongsToClub(clubId);
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ============================================
    // ğŸ‘¥ Members Collection
    // ============================================
    
    match /members/{memberId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ê°™ì€ í´ëŸ½
      allow read: if isAuthenticated() && (isAdmin() || belongsToClub(resource.data.clubId));
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(request.resource.data.clubId));
    }

    // ============================================
    // ğŸ† Competitions Collection
    // ============================================
    
    match /competitions/{competitionId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ğŸ“ Level Tests Collection
    // ============================================
    
    match /level_tests/{levelTestId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“‹ Requests Collections
    // ============================================
    
    match /clubOwnerRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ë³¸ì¸
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ì
      allow create: if isAuthenticated();
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();
    }
    
    match /superAdminRequests/{requestId} {
      // ê´€ë¦¬ìë§Œ
      allow read, write: if isSuperAdmin();
    }
    
    match /federationAdminInvites/{inviteId} {
      // ì½ê¸°: ëˆ„êµ¬ë‚˜ (ì´ˆëŒ€ ë§í¬ë¥¼ í†µí•œ ì ‘ê·¼ í—ˆìš©)
      allow read: if true;
      
      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isSuperAdmin();
      
      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” ì´ˆëŒ€ë°›ì€ ì‚¬ëŒ (ê°€ì… ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸)
      allow update: if isSuperAdmin() || (isAuthenticated() && resource.data.email == request.auth.token.email);
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // ğŸ« Passes & Attendance
    // ============================================
    
    match /member_passes/{passId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /attendance/{attendanceId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“š Classes & Templates
    // ============================================
    
    match /gym_classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /pass_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“¸ Media Collection
    // ============================================
    
    match /media/{mediaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ’° Financial Collections
    // ============================================
    
    match /payments/{paymentId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update: if isAdmin() || isClubStaff();
      allow delete: if isAdmin();
    }
    
    match /incomes/{incomeId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /expenses/{expenseId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /budgets/{budgetId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“¢ Announcements & Messages
    // ============================================
    
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /messageHistory/{messageId} {
      allow read: if isAdmin() || isClubStaff();
      allow create: if isAdmin() || isClubStaff();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // âš™ï¸ Settings Collections
    // ============================================
    
    match /club_bank_accounts/{accountId} {
      allow read: if isAdmin() || belongsToClub(accountId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(accountId));
    }
    
    match /naverCloudConfigs/{configId} {
      allow read: if isAdmin() || belongsToClub(configId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(configId));
    }

    // ============================================
    // ğŸš« Deny all other access
    // ============================================
    
    // ëª…ì‹œë˜ì§€ ì•Šì€ ëª¨ë“  ì ‘ê·¼ ì°¨ë‹¨
  }
}