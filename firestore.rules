/**
 * @file Firebase Security Rules for KGF Nexus (Production)
 * @description Role-based access control with domain-based architecture
 * 
 * Roles (defined in /src/constants/roles.ts):
 * - SUPER_ADMIN: Full system access
 * - FEDERATION_ADMIN: Federation-wide access
 * - CLUB_OWNER: Own club management access
 * - CLUB_MANAGER: Own club operational access
 * - COACH: Class and member management
 * - MEMBER: Own data access only
 * 
 * Domain Structure:
 * - Auth: Authentication and user management
 * - Member: Member data and operations
 * - Club: Club data and operations
 * - Business: Financial and administrative data
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ğŸ”§ Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'SUPER_ADMIN';
    }
    
    function isFederationAdmin() {
      return isAuthenticated() && getUserData().role == 'FEDERATION_ADMIN';
    }
    
    function isClubOwner() {
      return isAuthenticated() && getUserData().role == 'CLUB_OWNER';
    }
    
    function isClubManager() {
      return isAuthenticated() && getUserData().role == 'CLUB_MANAGER';
    }
    
    function isCoach() {
      return isAuthenticated() && getUserData().role == 'COACH';
    }
    
    function isClubStaff() {
      return isClubOwner() || isClubManager() || isCoach();
    }
    
    function isMember() {
      return isAuthenticated() && getUserData().role == 'MEMBER';
    }
    
    function isAdmin() {
      return isSuperAdmin() || isFederationAdmin();
    }
    
    function belongsToClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }

    // ============================================
    // ğŸ‘¤ Users Collection
    // ============================================
    
    match /users/{userId} {
      // ìê¸° í”„ë¡œí•„ ì½ê¸°: ë³¸ì¸ì€ í•­ìƒ ê°€ëŠ¥ (ìˆœí™˜ ì°¸ì¡° ë°©ì§€)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // ë‹¤ë¥¸ ì‚¬ìš©ì í”„ë¡œí•„ ì½ê¸°: ê´€ë¦¬ìë§Œ (ìµœì í™”: í•œ ë²ˆë§Œ ì²´í¬)
      allow read: if isAuthenticated() && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
      
      // í”„ë¡œí•„ ìƒì„±: ë³¸ì¸ë§Œ
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // í”„ë¡œí•„ ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ìµœì í™”)
      allow update: if isAuthenticated() && 
                       (request.auth.uid == userId || 
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN']);
      
      // í”„ë¡œí•„ ì‚­ì œ: ê´€ë¦¬ìë§Œ (ìµœì í™”)
      allow delete: if isAuthenticated() && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
      
      // ì „ì²´ ëª©ë¡: ê´€ë¦¬ìë§Œ (ìµœì í™”)
      allow list: if isAuthenticated() && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['SUPER_ADMIN', 'FEDERATION_ADMIN'];
    }

    // ============================================
    // ğŸ¢ Clubs Collection
    // ============================================
    
    match /clubs/{clubId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì ëˆ„êµ¬ë‚˜ (ëª¨ë“  í´ëŸ½ ì •ë³´ëŠ” ê³µê°œ)
      allow read: if isAuthenticated();
      
      // ìƒì„±: ê´€ë¦¬ìë§Œ (í´ëŸ½ ë“±ë¡ ìŠ¹ì¸ í›„ ìƒì„±)
      allow create: if isAdmin();
      
      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ì˜¤ë„ˆ
      allow update: if isAdmin() || 
                       (isAuthenticated() && 
                        resource.data.ownerId == request.auth.uid);
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
      
      // ì „ì²´ ëª©ë¡ ì¡°íšŒ: ì¸ì¦ëœ ì‚¬ìš©ì ëˆ„êµ¬ë‚˜
      allow list: if isAuthenticated();
    }

    // ============================================
    // ğŸ‘¥ Members Collection (Domain: Member)
    // ============================================
    
    match /members/{memberId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || 
                     isClubStaff() || 
                     (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // ìƒì„±: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„ (íšŒì› ë“±ë¡ ìŠ¹ì¸ í›„)
      allow create: if isAdmin() || isClubStaff();
      
      // ìˆ˜ì •: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸ (ì œí•œì )
      allow update: if isAdmin() || 
                       isClubStaff() || 
                       (isAuthenticated() && 
                        resource.data.userId == request.auth.uid && 
                        // ë³¸ì¸ì€ ê°œì¸ì •ë³´ë§Œ ìˆ˜ì • ê°€ëŠ¥
                        !('status' in request.resource.data.diff(resource.data).affectedKeys()) &&
                        !('level' in request.resource.data.diff(resource.data).affectedKeys()) &&
                        !('clubId' in request.resource.data.diff(resource.data).affectedKeys()));
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
      
      // ëª©ë¡ ì¡°íšŒ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow list: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ† Competitions Collection
    // ============================================
    
    match /competitions/{competitionId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ğŸ“ Level Tests Collection
    // ============================================
    
    match /level_tests/{levelTestId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“‹ Requests Collections
    // ============================================
    
    match /clubOwnerRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ë³¸ì¸
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // ìƒì„±: ëˆ„êµ¬ë‚˜ ê°€ëŠ¥ (ê°€ì… ì‹ ì²­ì€ ë¹„íšŒì›ë„ ê°€ëŠ¥)
      allow create: if true;
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();
    }
    
    match /superAdminRequests/{requestId} {
      // ì½ê¸°/ìˆ˜ì •/ì‚­ì œ: SUPER_ADMINë§Œ
      allow read, update, delete: if isSuperAdmin();
      
      // ìƒì„±: ëˆ„êµ¬ë‚˜ ê°€ëŠ¥ (ìµœê³  ê´€ë¦¬ì ì‹ ì²­)
      allow create: if true;
    }
    
    match /federationAdminInvites/{inviteId} {
      // ì½ê¸°: ëˆ„êµ¬ë‚˜ (ì´ˆëŒ€ ë§í¬ë¥¼ í†µí•œ ì ‘ê·¼ í—ˆìš©)
      allow read: if true;
      
      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isSuperAdmin();
      
      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” ì´ˆëŒ€ë°›ì€ ì‚¬ëŒ (ê°€ì… ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸)
      allow update: if isSuperAdmin() || (isAuthenticated() && resource.data.email == request.auth.token.email);
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isSuperAdmin();
    }
    
    match /coachRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ìš”ì²­í•œ í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || (isClubStaff() && resource.data.requestedBy == request.auth.uid);
      
      // ìƒì„±: í´ëŸ½ ìŠ¤íƒœí”„
      allow create: if isClubStaff();
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();
    }
    
    match /memberRegistrationRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // ìƒì„±: ëˆ„êµ¬ë‚˜ (íšŒì› ê°€ì… ì‹ ì²­)
      allow create: if true;
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // ì„±ì¸ íšŒì› ê°€ì… ì‹ ì²­
    match /adultRegistrationRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // ìƒì„±: ëˆ„êµ¬ë‚˜
      allow create: if true;
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // ê°€ì¡± íšŒì› ê°€ì… ì‹ ì²­
    match /familyRegistrationRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      
      // ìƒì„±: ëˆ„êµ¬ë‚˜
      allow create: if true;
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í•´ë‹¹ í´ëŸ½ ìŠ¤íƒœí”„
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    // Deprecated: memberRequestsëŠ” memberRegistrationRequestsë¡œ í†µí•©ë¨
    match /memberRequests/{requestId} {
      allow read, write: if false; // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    }

    // ============================================
    // ğŸ« Passes & Attendance (Domain: Member)
    // ============================================
    
    match /member_passes/{passId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /attendance/{attendanceId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“š Classes & Templates (Domain: Club)
    // ============================================
    
    match /gym_classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /pass_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“¸ Media Collection
    // ============================================
    
    match /media/{mediaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ’° Financial Collections (Domain: Business)
    // ============================================
    
    match /payments/{paymentId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update: if isAdmin() || isClubStaff();
      allow delete: if isAdmin();
    }
    
    match /financial_transactions/{transactionId} {
      allow read: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
      allow create: if isAdmin() || isClubStaff();
      allow update, delete: if isAdmin() || (isClubStaff() && belongsToClub(resource.data.clubId));
    }
    
    match /incomes/{incomeId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /expenses/{expenseId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /budgets/{budgetId} {
      allow read: if isAdmin() || isClubStaff();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“¢ Announcements & Messages (Domain: Business)
    // ============================================
    
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /messageHistory/{messageId} {
      allow read: if isAdmin() || isClubStaff();
      allow create: if isAdmin() || isClubStaff();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // âš™ï¸ Settings Collections
    // ============================================
    
    match /club_bank_accounts/{accountId} {
      allow read: if isAdmin() || belongsToClub(accountId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(accountId));
    }
    
    match /naverCloudConfigs/{configId} {
      allow read: if isAdmin() || belongsToClub(configId);
      allow create, update, delete: if isAdmin() || (isClubStaff() && belongsToClub(configId));
    }

    // ============================================
    // ğŸ›ï¸ Committees (ìœ„ì›íšŒ)
    // ============================================
    
    match /committees/{committeeId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ğŸ‰ Events & Registrations (í´ëŸ½ ì´ë²¤íŠ¸)
    // ============================================
    
    match /events/{eventId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow create, update, delete: if isAdmin() || isClubStaff();
    }
    
    match /event_registrations/{registrationId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ì
      allow create: if isAuthenticated();
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ“ Level Test Registrations (ìŠ¹ê¸‰ì‹¬ì‚¬ ì°¸ê°€)
    // ============================================
    
    match /level_test_registrations/{registrationId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ì
      allow create: if isAuthenticated();
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” í´ëŸ½ ìŠ¤íƒœí”„
      allow update, delete: if isAdmin() || isClubStaff();
    }

    // ============================================
    // ğŸ† Competition Registrations (ëŒ€íšŒ ì°¸ê°€)
    // ============================================
    
    match /competition_registrations/{registrationId} {
      // ì½ê¸°: ê´€ë¦¬ì, í´ëŸ½ ìŠ¤íƒœí”„, ë³¸ì¸
      allow read: if isAdmin() || isClubStaff() || (isAuthenticated() && resource.data.memberId == request.auth.uid);
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ì
      allow create: if isAuthenticated();
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();
    }

    // ============================================
    // âš–ï¸ Judges (ì‹¬íŒ)
    // ============================================
    
    match /judges/{judgeId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ğŸš« Deny all other access
    // ============================================
    
    // ëª…ì‹œë˜ì§€ ì•Šì€ ëª¨ë“  ì ‘ê·¼ ì°¨ë‹¨
  }
}