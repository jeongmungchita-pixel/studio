import { describe, it, expect, beforeEach, vi } from 'vitest';
import { VulnerabilityScanner, VulnerabilitySeverity, VulnerabilityType, type ScanResult } from '../vulnerability-scanner';

// Helper to create a minimal ScanResult for report tests
function createMockScanResult(overrides: Partial<ScanResult> = {}): ScanResult {
  const base: ScanResult = {
    id: 'scan_mock_1',
    startTime: new Date(Date.now() - 1000),
    endTime: new Date(),
    duration: 1000,
    vulnerabilities: [
      {
        id: 'v1',
        type: VulnerabilityType.SECURITY_MISCONFIGURATION,
        severity: VulnerabilitySeverity.LOW,
        title: 'Debug Information Exposure',
        description: 'Console logging enabled',
        location: 'Console Output',
        recommendation: 'Disable console in production',
        discoveredAt: new Date(),
        status: 'open',
      },
    ],
    summary: { total: 1, critical: 0, high: 0, medium: 0, low: 1, info: 0 },
    riskScore: 10,
  };
  return { ...base, ...overrides } as ScanResult;
}

describe('VulnerabilityScanner - runFullScan (node env)', () => {
  beforeEach(() => {
    // Ensure browser globals are not present to exercise non-DOM code paths
    // @ts-expect-error
    global.window = undefined;
    // @ts-expect-error
    global.document = undefined;
  });

  it('returns a valid ScanResult and includes configuration vulnerability in node/test env', async () => {
    const result = await VulnerabilityScanner.runFullScan();

    expect(result.id).toMatch(/^scan_\d+_/);
    expect(result.duration).toBeGreaterThanOrEqual(0);
    expect(result.startTime instanceof Date).toBe(true);
    expect(result.endTime instanceof Date).toBe(true);

    // In node test env, most DOM-dependent scans are skipped, but configuration scan can add a LOW vuln
    expect(Array.isArray(result.vulnerabilities)).toBe(true);
    expect(result.summary.total).toBe(result.vulnerabilities.length);

    // Risk score normalized 0-100
    expect(result.riskScore).toBeGreaterThanOrEqual(0);
    expect(result.riskScore).toBeLessThanOrEqual(100);

    // If any vulnerability exists, at least one should be SECURITY_MISCONFIGURATION (console native check)
    if (result.vulnerabilities.length > 0) {
      const hasMisconfig = result.vulnerabilities.some(v => v.type === VulnerabilityType.SECURITY_MISCONFIGURATION);
      expect(hasMisconfig).toBe(true);
    }
  });
});

describe('VulnerabilityScanner - generateReport formats', () => {
  it('generates JSON report', () => {
    const scan = createMockScanResult();
    const json = VulnerabilityScanner.generateReport(scan, 'json');
    const parsed = JSON.parse(json);
    expect(parsed.id).toBe(scan.id);
    expect(parsed.summary.total).toBe(1);
  });

  it('generates HTML report', () => {
    const scan = createMockScanResult();
    const html = VulnerabilityScanner.generateReport(scan, 'html');
    expect(typeof html).toBe('string');
    expect(html).toContain('<!DOCTYPE html>');
    expect(html).toContain('Security Scan Report');
    expect(html).toContain('Debug Information Exposure');
  });

  it('generates CSV report', () => {
    const scan = createMockScanResult();
    const csv = VulnerabilityScanner.generateReport(scan, 'csv');
    const lines = csv.split('\n');
    expect(lines[0]).toContain('ID,Type,Severity,Title');
    expect(csv).toContain('Debug Information Exposure');
  });
});
