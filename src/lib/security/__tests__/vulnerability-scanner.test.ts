import { describe, it, expect, vi, beforeEach } from 'vitest';
import { VulnerabilityScanner, VulnerabilitySeverity, VulnerabilityType } from '../vulnerability-scanner';

function setupDom(html: string = '<!doctype html><html><head></head><body></body></html>') {
  // jsdom 환경에서 document 초기화 (Vitest 기본 jsdom 가정)
  document.write(html);
  document.close();
}

describe('VulnerabilityScanner', () => {
  beforeEach(() => {
    // DOM 초기화
    setupDom();
    // 환경 변수/글로벌 초기화
    vi.stubEnv('NODE_ENV', 'test');
  });

  it('runFullScan returns ScanResult with summary and riskScore', async () => {
    // 인라인 이벤트 핸들러(XSS) 및 폼 CSRF 미설정, 보안 헤더 메타 없음 등을 포함한 DOM 구성
    setupDom(`
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8" />
        </head>
        <body>
          <button onclick="alert('x')">click</button>
          <form method="post" action="/submit">
            <input name="name"/>
          </form>
          <script>var token = 'secret_token_value'</script>
        </body>
      </html>
    `);

    // navigation entries 모킹 (scanHeaders 일부 로직이 performance API를 조건부 참조)
    const perfAny = performance as any;
    if (!perfAny.getEntriesByType) {
      perfAny.getEntriesByType = vi.fn(() => []);
    }

    const result = await VulnerabilityScanner.runFullScan();

    expect(result.id).toMatch(/^scan_/);
    expect(result.startTime).toBeInstanceOf(Date);
    expect(result.endTime).toBeInstanceOf(Date);
    expect(result.duration).toBeGreaterThanOrEqual(0);

    // 요약 구조
    expect(result.summary).toEqual(
      expect.objectContaining({ total: expect.any(Number) })
    );

    // 위험도 점수 범위 체크
    expect(result.riskScore).toBeGreaterThanOrEqual(0);
    expect(result.riskScore).toBeLessThanOrEqual(100);

    // 일부 취약점 유형이 포함될 가능성 확인 (환경에 따라 0일 수 있으므로 포함 가능성 위주 체크)
    expect(Array.isArray(result.vulnerabilities)).toBe(true);
  });

  it('generateReport returns json/html/csv formats', async () => {
    const scan = await VulnerabilityScanner.runFullScan();
    const json = VulnerabilityScanner.generateReport(scan, 'json');
    expect(() => JSON.parse(json)).not.toThrow();

    const html = VulnerabilityScanner.generateReport(scan, 'html');
    expect(html).toContain('<html>');
    expect(html).toContain('Security Scan Report');

    const csv = VulnerabilityScanner.generateReport(scan, 'csv');
    expect(csv.split('\n')[0]).toContain('ID,Type,Severity,Title');
  });

  it('calculate risk score increases with higher severity counts (indirect via runFullScan)', async () => {
    // 강제로 HIGH/CRITICAL 급 취약점 유발 요소 삽입
    setupDom(`
      <!doctype html>
      <html>
        <body>
          <form method="post"><input name="username"/></form>
          <script>const password = 'admin'; const key = 'api_key';</script>
          <input type="hidden" name="role" value="SUPER_ADMIN"/>
        </body>
      </html>
    `);
    const res = await VulnerabilityScanner.runFullScan();
    expect(res.summary.total).toBeGreaterThanOrEqual(0);
    expect(res.riskScore).toBeGreaterThanOrEqual(0);
  });
});
